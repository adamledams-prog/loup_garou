<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loup-Garou - Vote</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            overflow-y: auto;
        }

        .container {
            max-width: 600px;
            margin: 30px auto;
            min-height: auto;
        }

        .vote-container {
            text-align: center;
        }

        .phase-title {
            font-size: 2em;
            color: #f39c12;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .death-announce {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            font-size: 1.3em;
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.3);
        }

        .death-announce .skull {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .alive-announce {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            font-size: 1.3em;
            box-shadow: 0 8px 25px rgba(39, 174, 96, 0.3);
        }

        .vote-section {
            margin: 30px 0;
        }

        .vote-title {
            font-size: 1.5em;
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .player-vote-list {
            display: grid;
            gap: 12px;
            margin: 20px 0;
        }

        .vote-btn {
            padding: 18px 25px;
            background: white;
            border: 3px solid #667eea;
            border-radius: 12px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: #2c3e50;
            position: relative;
            overflow: hidden;
        }

        .vote-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.2), transparent);
            transition: left 0.5s;
        }

        .vote-btn:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateX(5px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .vote-btn:hover::before {
            left: 100%;
        }

        .vote-btn.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
        }

        .vote-btn.dead {
            opacity: 0.4;
            text-decoration: line-through;
            background: #ecf0f1;
            border-color: #95a5a6;
            cursor: not-allowed;
            pointer-events: none;
        }

        .vote-count {
            display: inline-block;
            background: #e74c3c;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-left: 10px;
            font-weight: bold;
        }

        .btn-confirm-vote {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.3);
        }

        .btn-confirm-vote:hover {
            box-shadow: 0 12px 35px rgba(231, 76, 60, 0.5);
        }

        .btn-next-night {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            box-shadow: 0 8px 25px rgba(44, 62, 80, 0.3);
        }

        .btn-next-night:hover {
            box-shadow: 0 12px 35px rgba(44, 62, 80, 0.5);
        }

        .sun {
            font-size: 4em;
            animation: sunShine 3s ease-in-out infinite;
            filter: drop-shadow(0 0 20px rgba(255, 200, 50, 0.8));
        }

        @keyframes sunShine {
            0%, 100% {
                filter: drop-shadow(0 0 20px rgba(255, 200, 50, 0.8));
                transform: scale(1);
            }
            50% {
                filter: drop-shadow(0 0 35px rgba(255, 200, 50, 1));
                transform: scale(1.1);
            }
        }

        .game-over {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
            font-size: 1.5em;
            box-shadow: 0 10px 30px rgba(243, 156, 18, 0.4);
        }

        .winner-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="night-counter" id="nightCounter">Nuit 1</div>
    
    <div class="container">
        <div class="sun">‚òÄÔ∏è</div>
        <h1>Le jour se l√®ve</h1>
        
        <div id="voteContainer" class="vote-container">
            <div id="deathAnnounce"></div>
            
            <div class="vote-section" id="voteSection">
                <div class="vote-title">üó≥Ô∏è Votez pour √©liminer un joueur</div>
                
                <div class="timer-container" id="timerContainer" style="display: none;">
                    <div class="timer-text">Temps restant</div>
                    <div class="timer-display" id="timerDisplay">30</div>
                    <div class="timer-bar-container">
                        <div class="timer-bar" id="timerBar"></div>
                    </div>
                </div>
                
                <div class="player-vote-list" id="playerVoteList"></div>
                
                <button class="btn-start btn-confirm-vote" id="btnConfirmVote" onclick="confirmVote()" style="display: none;">
                    Confirmer mon vote
                </button>
            </div>

            <div id="eliminationResult" class="elimination-result" style="display: none;"></div>
            
            <button class="btn-start btn-next-night" id="btnNextNight" onclick="nextNight()" style="display: none;">
                Passer √† la nuit suivante
            </button>
        </div>
    </div>

    <script>
        let players = [];
        let roles = [];
        let gameState = {};
        let votes = {};
        let selectedVote = null;
        let timerInterval = null;
        let timeRemaining = 30;
        let currentVoterIndex = 0;
        let alivePlayers = [];

        function initVote() {
            players = JSON.parse(localStorage.getItem('players') || '[]');
            roles = JSON.parse(localStorage.getItem('roles') || '[]');
            
            const savedState = localStorage.getItem('gameState');
            if (savedState) {
                gameState = JSON.parse(savedState);
            } else {
                gameState = {
                    deadPlayers: [],
                    allDeadPlayers: [],
                    killedTonight: null,
                    witchHealUsed: false,
                    witchPoisonUsed: false,
                    shieldUsed: false
                };
            }
            
            // Ajouter les morts de cette nuit aux morts totaux
            if (!gameState.allDeadPlayers) {
                gameState.allDeadPlayers = [];
            }
            if (gameState.deadPlayers && gameState.deadPlayers.length > 0) {
                gameState.deadPlayers.forEach(index => {
                    if (!gameState.allDeadPlayers.includes(index)) {
                        gameState.allDeadPlayers.push(index);
                    }
                });
            }
            
            // Initialiser les votes
            votes = {};
            currentVoterIndex = 0;
            
            // Cr√©er la liste des joueurs vivants
            alivePlayers = [];
            players.forEach((player, index) => {
                if (!gameState.allDeadPlayers.includes(index)) {
                    alivePlayers.push(index);
                }
            });
            
            // Afficher le compteur de nuits
            updateNightCounter();
            
            // Afficher l'annonce des morts
            showDeathAnnouncement();
            
            // D√©marrer le tour de vote
            startVotingRound();
        }

        function updateNightCounter() {
            const nightNumber = gameState.nightNumber || 1;
            document.getElementById('nightCounter').textContent = `Nuit ${nightNumber}`;
        }

        function startVotingRound() {
            if (currentVoterIndex >= alivePlayers.length) {
                // Tous les joueurs ont vot√©
                endVoting();
                return;
            }

            const voterIndex = alivePlayers[currentVoterIndex];
            const voterName = players[voterIndex];
            
            // Mettre √† jour le titre pour montrer qui doit voter
            document.querySelector('.vote-title').innerHTML = `üó≥Ô∏è <strong>${voterName}</strong>, choisis qui √©liminer`;
            
            // Cr√©er la liste de vote
            createVoteList();
            
            // Afficher le bouton de confirmation
            document.getElementById('btnConfirmVote').style.display = 'block';
            selectedVote = null;
        }

        function endVoting() {
            document.getElementById('voteSection').style.display = 'none';
            eliminatePlayer();
        }

        function updateNightCounter() {
            const nightNumber = gameState.nightNumber || 1;
            document.getElementById('nightCounter').textContent = `Nuit ${nightNumber}`;
        }

        function startTimer() {
            document.getElementById('btnStartTimer').style.display = 'none';
            document.getElementById('timerContainer').style.display = 'block';
            
            timeRemaining = 30;
            updateTimerDisplay();
            
            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    autoEliminate();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const display = document.getElementById('timerDisplay');
            const bar = document.getElementById('timerBar');
            
            display.textContent = timeRemaining;
            bar.style.width = (timeRemaining / 30 * 100) + '%';
            
            if (timeRemaining <= 10) {
                display.classList.add('warning');
                bar.classList.add('warning');
            } else {
                display.classList.remove('warning');
                bar.classList.remove('warning');
            }
        }

        function autoEliminate() {
            if (Object.keys(votes).length === 0) {
                alert('Temps √©coul√© ! Personne n\'a vot√©.');
                document.getElementById('btnNextNight').style.display = 'block';
                return;
            }
            
            eliminatePlayer();
        }

        function showDeathAnnouncement() {
            const deathAnnounce = document.getElementById('deathAnnounce');
            
            // V√©rifier s'il y a des morts cette nuit
            const newDeaths = gameState.deadPlayers || [];
            
            if (newDeaths.length > 0) {
                let html = '<div class="death-announce">';
                html += '<div class="skull">üíÄ</div>';
                html += '<div>Cette nuit, les victimes sont :</div>';
                html += '<div style="margin-top: 15px; font-size: 1.3em;">';
                newDeaths.forEach(index => {
                    html += `<div style="margin: 10px 0;"><strong>${players[index]}</strong></div>`;
                });
                html += '</div></div>';
                
                deathAnnounce.innerHTML = html;
                deathAnnounce.style.display = 'block';
            } else {
                deathAnnounce.innerHTML = '<div class="death-announce">üåÖ<br>Personne n\'est mort cette nuit !</div>';
                deathAnnounce.style.display = 'block';
            }
        }

        function confirmVote() {
            if (selectedVote === null) {
                alert('Tu dois choisir un joueur !');
                return;
            }

            const voterIndex = alivePlayers[currentVoterIndex];
            const voterName = players[voterIndex];
            
            // Enregistrer le vote
            votes[voterName] = selectedVote;
            
            // Afficher un message de confirmation
            alert(`${voterName} a vot√© pour ${players[selectedVote]}`);
            
            // Passer au joueur suivant
            currentVoterIndex++;
            selectedVote = null;
            
            // Mettre √† jour l'affichage des votes
            startVotingRound();
        }

        function createVoteList() {
            const voteList = document.getElementById('playerVoteList');
            let html = '';
            
            players.forEach((player, index) => {
                const isDead = gameState.allDeadPlayers.includes(index);
                const voteCount = Object.values(votes).filter(v => v === index).length;
                
                html += `<button class="vote-btn ${isDead ? 'dead' : ''}" 
                         onclick="selectVote(${index})" 
                         id="vote-${index}"
                         ${isDead ? 'disabled' : ''}>
                    ${player}
                    ${voteCount > 0 ? `<span class="vote-count">${voteCount} vote${voteCount > 1 ? 's' : ''}</span>` : ''}
                </button>`;
            });
            
            voteList.innerHTML = html;
        }

        function selectVote(playerIndex) {
            if (gameState.allDeadPlayers.includes(playerIndex)) return;
            
            selectedVote = playerIndex;
            
            // Mettre √† jour l'affichage
            document.querySelectorAll('.vote-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.getElementById(`vote-${playerIndex}`).classList.add('selected');
            
            document.getElementById('btnConfirmVote').style.display = 'block';
        }

        function eliminatePlayer() {
            // Compter les votes
            const voteCounts = {};
            Object.values(votes).forEach(vote => {
                voteCounts[vote] = (voteCounts[vote] || 0) + 1;
            });

            // Trouver le joueur avec le plus de votes
            let maxVotes = 0;
            let eliminatedPlayer = null;

            
            for (const [playerIndex, count] of Object.entries(voteCounts)) {
                if (count > maxVotes) {
                    maxVotes = count;
                    eliminatedPlayer = parseInt(playerIndex);
                }
            }

            if (eliminatedPlayer !== null) {
                // V√©rifier si c'est le bouclier
                if (roles[eliminatedPlayer] === 'bouclier' && !gameState.shieldUsed) {
                    gameState.shieldUsed = true;
                    const resultDiv = document.getElementById('eliminationResult');
                    resultDiv.innerHTML = `
                        <div class="death-announce" style="margin-top: 30px;">
                            <div class="skull">üõ°Ô∏è</div>
                            <div style="font-size: 1.6em; margin: 20px 0; font-weight: 800;">
                                <strong>${players[eliminatedPlayer]}</strong> a surv√©cu !
                            </div>
                            <div style="font-size: 1.2em; opacity: 0.95; margin-top: 15px;">
                                Le BOUCLIER a utilis√© son pouvoir de protection !
                            </div>
                        </div>
                    `;
                    resultDiv.style.display = 'block';
                    // Ne pas ajouter √† allDeadPlayers
                } else {
                    // √âliminer le joueur
                    gameState.allDeadPlayers.push(eliminatedPlayer);
                    
                    let resultHTML = `
                        <div class="death-announce" style="margin-top: 30px;">
                            <div class="skull">‚öñÔ∏è</div>
                            <div style="font-size: 1.6em; margin: 20px 0; font-weight: 800;">
                                <strong>${players[eliminatedPlayer]}</strong> a √©t√© √©limin√© par vote !
                            </div>
                            <div style="font-size: 1.2em; opacity: 0.95; margin-top: 15px;">
                                Son r√¥le √©tait : <strong>${getRoleName(roles[eliminatedPlayer])}</strong>
                            </div>
                        </div>
                    `;
                    
                    // V√©rifier si c'est le renvoyeur
                    if (roles[eliminatedPlayer] === 'renvoyeur') {
                        gameState.renvoyeurEliminatedIndex = eliminatedPlayer;
                        gameState.renvoyeurResultHTML = resultHTML;
                        // Sauvegarder l'√©tat AVANT d'afficher le choix
                        localStorage.setItem('gameState', JSON.stringify(gameState));
                        showRenvoyeurChoice(eliminatedPlayer);
                        return; // Attendre le choix du renvoyeur - pas de v√©rification de victoire maintenant
                    }
                    
                    document.getElementById('eliminationResult').innerHTML = resultHTML;
                    document.getElementById('eliminationResult').style.display = 'block';
                }
                
                // Sauvegarder l'√©tat
                localStorage.setItem('gameState', JSON.stringify(gameState));
                
                // V√©rifier les conditions de victoire
                checkWinCondition();
                
                // Afficher le bouton pour la nuit suivante
                document.getElementById('btnNextNight').style.display = 'block';
            } else {
                alert('Aucun vote enregistr√© !');
            }
        }

        function checkWinCondition() {
            const loupAlive = roles.some((role, index) => 
                role === 'loup' && !gameState.allDeadPlayers.includes(index)
            );

            if (!loupAlive) {
                showGameOver('Les Villageois ont gagn√© !', 'üë®‚Äçüåæüéâ');
                return;
            }

            const villagersAlive = roles.filter((role, index) => 
                role !== 'loup' && !gameState.allDeadPlayers.includes(index)
            ).length;
            
            const loupsAlive = roles.filter((role, index) => 
                role === 'loup' && !gameState.allDeadPlayers.includes(index)
            ).length;

            // Le loup gagne si le nombre de loups est >= au nombre de villageois
            if (loupsAlive >= villagersAlive) {
                showGameOver('Le Loup-Garou a gagn√© !', 'üê∫üéâ');
                return;
            }
        }

        function showGameOver(message, icon) {
            document.getElementById('voteSection').style.display = 'none';
            document.getElementById('deathAnnounce').innerHTML += 
                `<div class="game-over">
                    <div class="winner-icon">${icon}</div>
                    <div><strong>${message}</strong></div>
                    <button class="btn-start" onclick="restartGame()" style="margin-top: 20px;">
                        üîÑ Nouvelle partie
                    </button>
                </div>`;
        }

        function restartGame() {
            localStorage.clear();
            window.location.href = 'index.html';
        }

        function showRenvoyeurChoice(eliminatedPlayer) {
            let html = gameState.renvoyeurResultHTML;
            
            html += `
                <div class="death-announce" style="margin-top: 30px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
                    <div class="skull" style="font-size: 3em;">‚Ü©Ô∏è</div>
                    <div style="font-size: 1.8em; margin: 20px 0; font-weight: 900;">
                        POUVOIR DU RENVOYEUR
                    </div>
                    <div style="font-size: 1.3em; margin: 15px 0;">
                        <strong>${players[eliminatedPlayer]}</strong>, choisis qui √©liminer !
                    </div>
                    <div class="player-vote-list" style="margin-top: 25px;">
            `;
            
            players.forEach((player, index) => {
                if (index !== eliminatedPlayer && !gameState.allDeadPlayers.includes(index)) {
                    html += `
                        <button class="vote-btn" onclick="renvoyeurKill(${index})" 
                                style="background: white; color: #2c3e50; border-color: #e74c3c;">
                            ${player}
                        </button>
                    `;
                }
            });
            
            html += `
                    </div>
                </div>
            `;
            
            document.getElementById('eliminationResult').innerHTML = html;
            document.getElementById('eliminationResult').style.display = 'block';
        }

        function renvoyeurKill(targetIndex) {
            // Ajouter la victime du renvoyeur aux morts
            gameState.allDeadPlayers.push(targetIndex);
            
            let resultHTML = gameState.renvoyeurResultHTML;
            resultHTML += `
                <div class="death-announce" style="margin-top: 30px;">
                    <div class="skull">‚Ü©Ô∏è</div>
                    <div style="font-size: 1.6em; margin: 20px 0; font-weight: 800;">
                        Le RENVOYEUR a √©limin√© <strong>${players[targetIndex]}</strong> !
                    </div>
                    <div style="font-size: 1.2em; opacity: 0.95; margin-top: 15px;">
                        Son r√¥le √©tait : <strong>${getRoleName(roles[targetIndex])}</strong>
                    </div>
                </div>
            `;
            
            document.getElementById('eliminationResult').innerHTML = resultHTML;
            
            // Nettoyer les variables temporaires
            delete gameState.renvoyeurEliminatedIndex;
            delete gameState.renvoyeurResultHTML;
            
            // Sauvegarder l'√©tat
            localStorage.setItem('gameState', JSON.stringify(gameState));
            
            // V√©rifier les conditions de victoire
            checkWinCondition();
            
            // Afficher le bouton pour la nuit suivante
            document.getElementById('btnNextNight').style.display = 'block';
        }

        function getRoleName(role) {
            const names = {
                'loup': 'üê∫ LOUP-GAROU',
                'voyante': 'üîÆ VOYANTE',
                'sorciere': 'üßô‚Äç‚ôÄÔ∏è SORCI√àRE',
                'bouclier': 'üõ°Ô∏è BOUCLIER',
                'renvoyeur': '‚Ü©Ô∏è RENVOYEUR'
            };
            return names[role] || role;
        }

        function nextNight() {
            // R√©initialiser les morts de la nuit
            gameState.killedTonight = null;
            
            // Incr√©menter le compteur de nuits
            gameState.nightNumber = (gameState.nightNumber || 1) + 1;
            
            localStorage.setItem('gameState', JSON.stringify(gameState));
            
            window.location.href = 'night.html';
        }

        initVote();
    </script>
</body>
</html>
